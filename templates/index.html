<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SuperBOT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen px-4">
  <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-md max-w-md w-full text-lg sm:text-xl mx-auto">
    
    <!-- üî§ –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à -->
    <div class="flex justify-end text-sm mb-4">
      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
      <span class="mx-1 text-gray-400">/</span>
      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
    </div>

    <!-- üßæ –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <h2 id="welcome" class="text-2xl font-bold text-center mb-2">“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</h2>
    <p id="subtitle" class="text-sm text-center text-gray-500 mb-6">3 –∫“Ø–Ω–¥—ñ–∫ —Ç–µ–≥—ñ–Ω –∫–µ–∑–µ“£–¥—ñ –±–∞—Å—Ç–∞“£—ã–∑</p>

    <form class="space-y-4 w-full" onsubmit="return validateForm()">
      <div>
        <label id="label-phone" class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ</label>
        <input id="phone" type="tel" maxlength="18" value="+7 "
               class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:outline-none" required />
      </div>

      <div>
        <label id="label-password" class="block text-sm font-medium text-gray-700 mb-1">“ö“±–ø–∏—è—Å”©–∑</label>
        <div class="relative">
          <input id="password" type="password" placeholder="“ö“±–ø–∏—è—Å”©–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑"
                 class="w-full border border-gray-300 rounded-lg p-2 pr-10 focus:ring-blue-500 focus:outline-none" required />
          <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-2 flex items-center text-gray-500">üëÅÔ∏è</button>
        </div>
        <p id="password-error" class="text-red-600 text-sm mt-1 hidden">
          “ö“±–ø–∏—è—Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞–¥–∞–Ω —Ç“±—Ä—É—ã –∂”ô–Ω–µ a-z ”ô—Ä—ñ–ø –ø–µ–Ω —Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.
        </p>
      </div>

      <button id="login-button" type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">–ö—ñ—Ä—É</button>
    </form>

    <div class="text-sm text-center mt-4">
      <a href="/forgot_password" class="text-blue-600 hover:underline" id="forgot">“ö“±–ø–∏—è—Å”©–∑–¥—ñ “±–º—ã—Ç—Ç—ã“£—ã–∑ –±–∞?</a>
    </div>
    <div class="text-sm text-center mt-2">
      <span id="no-account">–ê–∫–∫–∞—É–Ω—Ç –∂–æ“õ –ø–∞?</span>
      <a href="register" class="text-blue-600 hover:underline" id="register-link">–¢—ñ—Ä–∫–µ–ª—É</a>
    </div>
  </div>

  <script>
    const texts = {
      kk: {
        welcome: "“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!",
        subtitle: "3 –∫“Ø–Ω–¥—ñ–∫ —Ç–µ–≥—ñ–Ω –∫–µ–∑–µ“£–¥—ñ –±–∞—Å—Ç–∞“£—ã–∑",
        "label-phone": "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ",
        "label-password": "“ö“±–ø–∏—è—Å”©–∑",
        "login-button": "–ö—ñ—Ä—É",
        "forgot": "“ö“±–ø–∏—è—Å”©–∑–¥—ñ “±–º—ã—Ç—Ç—ã“£—ã–∑ –±–∞?",
        "no-account": "–ê–∫–∫–∞—É–Ω—Ç –∂–æ“õ –ø–∞?",
        "register-link": "–¢—ñ—Ä–∫–µ–ª—É",
        "password-placeholder": "“ö“±–ø–∏—è—Å”©–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑",
		"password-wrong": "“ö“±–ø–∏—è—Å”©–∑ “õ–∞—Ç–µ"
      },
      ru: {
        welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        subtitle: "–ù–∞—á–Ω–∏—Ç–µ 3-–¥–Ω–µ–≤–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥",
        "label-phone": "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "label-password": "–ü–∞—Ä–æ–ª—å",
        "login-button": "–í–æ–π—Ç–∏",
        "forgot": "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?",
        "no-account": "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?",
        "register-link": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
        "password-placeholder": "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å",
		"password-wrong": "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"
      }
    };

    function setLanguage(lang) {
      for (const key in texts[lang]) {
        const el = document.getElementById(key);
        if (el) el.innerText = texts[lang][key];
      }
      document.getElementById("password").placeholder = texts[lang]["password-placeholder"];
      localStorage.setItem('lang', lang);
    }

    function togglePassword() {
      const passwordInput = document.getElementById('password');
      passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
    }

	function validateForm() {
		const phone = document.getElementById("phone").value.trim();
		const password = document.getElementById("password").value.trim();
		const passwordError = document.getElementById('password-error');

		// “ö–∞—Ç–µ –∞–ª–¥—ã–Ω –∞–ª–∞ –∂–∞—Å—ã—Ä—ã–ø “õ–æ—è–º—ã–∑
		passwordError.classList.add('hidden');

		// –°–µ—Ä–≤–µ—Ä–≥–µ —Å“±—Ä–∞–Ω—ã—Å
		fetch("/login_check", {
			method: "POST",
			headers: {
			"Content-Type": "application/x-www-form-urlencoded"
			},
			body: new URLSearchParams({ phone, password })
		})
		.then(res => res.json())
		.then(data => {
			if (data.ok) {
			window.location.href = "/dashboard"; // ‚úÖ –õ–æ–≥–∏–Ω —Å”ô—Ç—Ç—ñ
			} else {
			// üî¥ –°–µ—Ä–≤–µ—Ä–¥–µ–Ω "“õ“±–ø–∏—è—Å”©–∑ –¥“±—Ä—ã—Å –µ–º–µ—Å" –¥–µ–ø –∫–µ–ª—Å–µ
			const lang = localStorage.getItem("lang") || "kk";
			passwordError.innerText = texts[lang]["password-wrong"];
			passwordError.classList.remove("hidden");
			}
		})
		.catch(err => {
			passwordError.innerText = "–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ";
			passwordError.classList.remove("hidden");
			console.error(err);
		});

		return false; // —Ñ–æ—Ä–º–∞ —Å–∞–±–º–∏—Ç –±–æ–ª–º–∞—Å—ã–Ω
	}

	const phoneInput = document.getElementById("phone");
    let prevValue = "";
    let prevCursorPos = 0;

    phoneInput.addEventListener("keydown", function (e) {
      prevValue = this.value;
      prevCursorPos = this.selectionStart;

      // +7 ”©—à–ø–µ—É—ñ –∫–µ—Ä–µ–∫
      if (e.key === "Backspace" && this.selectionStart <= 4) {
        e.preventDefault();
        return;
      }

      // –ë–æ—Å —Å–∏–º–≤–æ–ª ( ) –∞—Ä—Ç—ã–Ω–¥–∞ —Ç“±—Ä—Å–∞ ‚Äî –±—ñ—Ä–≥–µ ”©—à—ñ—Ä–µ–º—ñ–∑
      const c = this.value.charAt(this.selectionStart - 1);
      if (e.key === "Backspace" && [' ', ')', '('].includes(c)) {
        e.preventDefault();
        const pos = this.selectionStart;
        this.value = this.value.slice(0, pos - 2) + this.value.slice(pos);
        this.setSelectionRange(pos - 2, pos - 2);
      }
    });

    phoneInput.addEventListener("input", function () {
      let digits = this.value.replace(/\D/g, '');

      if (!digits || digits === '7') {
        this.value = '+7 ';
        this.setSelectionRange(this.value.length, this.value.length);
        return;
      }

      if (digits.startsWith('7')) digits = digits.slice(1);
      if (digits.length > 10) digits = digits.slice(0, 10);

      let formatted = '+7';
      if (digits.length > 0) formatted += ' (' + digits.slice(0, 3);
      if (digits.length >= 3) formatted += ') ' + digits.slice(3, 6);
      if (digits.length >= 6) formatted += ' ' + digits.slice(6, 8);
      if (digits.length >= 8) formatted += ' ' + digits.slice(8, 10);

      this.value = formatted;

      const diff = this.value.length - prevValue.length;
      const newPos = prevCursorPos + diff;
      this.setSelectionRange(newPos, newPos);
    });

    phoneInput.addEventListener("focus", function () {
      setTimeout(() => {
        if (this.selectionStart < 4) {
          this.setSelectionRange(this.value.length, this.value.length);
        }
      }, 0);
    });

    window.onload = () => {
      const lang = localStorage.getItem("lang") || "kk";
      setLanguage(lang);
      phoneInput.value = '+7 ';
      phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length);
    };
  </script>
</body>
</html>
