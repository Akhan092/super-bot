<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SuperBOT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen px-6">
  <div class="bg-white p-6 sm:p-8 rounded-xl shadow max-w-md w-full mx-auto text-base sm:text-lg">

    <!-- üî§ –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à -->
    <div class="flex justify-end text-sm mb-4">
      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
      <span class="mx-1 text-gray-400">/</span>
      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
    </div>

    <h2 id="title" class="text-2xl font-bold mb-4 text-center">“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</h2>

    <form id="reset-form" onsubmit="return validateCode(event)">
      <div class="mb-3">
        <label id="label-phone" class="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ</label>
        <input id="phone" value="+7 " maxlength="18" required class="w-full p-2 border rounded" />
        <p id="phone-error" class="text-sm text-red-600 mt-1 hidden">“ö–∞—Ç–µ: –∫–æ–¥ –∂—ñ–±–µ—Ä—ñ–ª–º–µ–¥—ñ</p>
      </div>

      <div id="send-button-block">
        <button id="send-code-btn" type="button" onclick="sendSMS()" class="w-full bg-blue-600 text-white py-2 rounded">
          –ö–æ–¥ –∂—ñ–±–µ—Ä—É
        </button>
      </div>

      <div class="hidden" id="sms-code-block">
        <label id="label-code" class="block text-sm mb-1">SMS –∫–æ–¥</label>
        <input id="sms_code" maxlength="6" class="w-full p-2 border rounded mb-1" inputmode="numeric" />
        <p id="code-error" class="text-sm text-red-600 hidden mb-3">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</p>
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–ö–æ–¥—Ç—ã —Ç–µ–∫—Å–µ—Ä—É</button>
      </div>
    </form>

    <div class="hidden" id="password-section">
      <h3 id="title-password" class="text-lg font-semibold mb-3">–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑</h3>

      <div class="mb-3 relative flex items-center">
        <input id="new_password" type="password" class="w-full p-2 border rounded pr-10" />
        <button type="button" onclick="togglePassword('new_password')" class="absolute right-3 text-gray-500 flex items-center justify-center h-full">üëÅÔ∏è</button>
      </div>

      <div class="mb-3 relative flex items-center">
        <input id="repeat_password" type="password" placeholder="“ö–∞–π—Ç–∞ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" class="w-full p-2 border rounded pr-10" />
        <button type="button" onclick="togglePassword('repeat_password')" class="absolute right-3 text-gray-500 flex items-center justify-center h-full">üëÅÔ∏è</button>
      </div>
      <p id="password-hint-2" class="text-sm text-gray-500 mb-4">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä</p>

      <button id="save-button" onclick="saveNewPassword()" class="bg-blue-600 text-white w-full py-2 rounded">–°–∞“õ—Ç–∞—É</button>
      <p id="save-error" class="text-sm text-red-600 mt-2 hidden">“ö–∞—Ç–µ</p>
    </div>

    <div class="hidden text-center mt-4" id="success-section">
      <p id="success-message" class="text-green-600 font-semibold">“ö“±–ø–∏—è—Å”©–∑ —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã ‚úÖ</p>
      <a id="login-link" href="/" class="inline-block mt-3 bg-green-600 text-white py-2 px-4 rounded">–ö—ñ—Ä—É</a>
    </div>
  </div>

  <script>
    const texts = {
      kk: {
        title: "“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É",
        "label-phone": "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ",
        "label-code": "SMS –∫–æ–¥",
        "send-code": "–ö–æ–¥ –∂—ñ–±–µ—Ä—É",
        error_code: "–ö–æ–¥ –¥“±—Ä—ã—Å –µ–º–µ—Å",
        password_error: "“ö“±–ø–∏—è—Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞, ”ô—Ä—ñ–ø –ø–µ–Ω —Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫",
        password_match: "“ö“±–ø–∏—è—Å”©–∑–¥–µ—Ä —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π–¥—ñ",
        "title-password": "–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑",
        "placeholder-new": "–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑",
        "placeholder-repeat": "“ö–∞–π—Ç–∞ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑",
        "save-button": "–°–∞“õ—Ç–∞—É",
        "success-message": "“ö“±–ø–∏—è—Å”©–∑ —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã ‚úÖ",
        "login-link": "–ö—ñ—Ä—É",
        "password-hint-2": "“ö“±–ø–∏—è—Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 ”ô—Ä—ñ–ø (a-z) –∂”ô–Ω–µ 1 —Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫",
        send_error: "“ö–∞—Ç–µ: –∫–æ–¥ –∂—ñ–±–µ—Ä—ñ–ª–º–µ–¥—ñ ‚ùå"
      },
      ru: {
        title: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è",
        "label-phone": "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "label-code": "–°–ú–° –∫–æ–¥",
        "send-code": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥",
        error_code: "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥",
        password_error: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã",
        password_match: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç",
        "title-password": "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å",
        "placeholder-new": "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å",
        "placeholder-repeat": "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å",
        "save-button": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        "success-message": "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω ‚úÖ",
        "login-link": "–í–æ–π—Ç–∏",
        "password-hint-2": "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä",
        send_error: "–û—à–∏–±–∫–∞: –∫–æ–¥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚ùå"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("title").innerText = t.title;
      document.getElementById("label-phone").innerText = t["label-phone"];
      document.getElementById("label-code").innerText = t["label-code"];
      document.getElementById("send-code-btn").innerText = t["send-code"];
      localStorage.setItem("lang", lang);
      document.getElementById("title-password").innerText = t["title-password"];
      document.getElementById("new_password").placeholder = t["placeholder-new"];
      document.getElementById("repeat_password").placeholder = t["placeholder-repeat"];
      document.getElementById("save-button").innerText = t["save-button"];
      document.getElementById("success-message").innerText = t["success-message"];
      document.getElementById("login-link").innerText = t["login-link"];
      document.getElementById("password-hint-2").innerText = t["password-hint-2"];
	  document.getElementById("phone-error").innerText = t.send_error;
    }

    function togglePassword(id) {
      const field = document.getElementById(id);
      field.type = field.type === "password" ? "text" : "password";
    }

    function sendSMS() {
      const phone = document.getElementById("phone").value;
      const lang = localStorage.getItem("lang") || "kk";
      const phoneError = document.getElementById("phone-error");
      phoneError.classList.add("hidden");

      fetch("/send_code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone, mode: "reset" })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          document.getElementById("sms-code-block").classList.remove("hidden");
          document.getElementById("send-button-block").classList.add("hidden");
        } else {
          phoneError.innerText = data.msg || texts[lang].send_error;
          phoneError.classList.remove("hidden");
        }
      });
    }

    function validateCode(e) {
      e.preventDefault();
      const code = document.getElementById("sms_code").value;
      const phone = document.getElementById("phone").value;
      const lang = localStorage.getItem("lang") || "kk";
      const codeError = document.getElementById("code-error");

      codeError.classList.add("hidden");

      if (!/^\d{6}$/.test(code)) {
        codeError.innerText = texts[lang].error_code;
        codeError.classList.remove("hidden");
        return;
      }

      fetch("/verify_code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone, code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("reset-form").classList.add("hidden");
          document.getElementById("password-section").classList.remove("hidden");
        } else {
          codeError.innerText = texts[lang].error_code;
          codeError.classList.remove("hidden");
        }
      });
    }

    function saveNewPassword() {
      const pass1 = document.getElementById("new_password").value;
      const pass2 = document.getElementById("repeat_password").value;
      const phone = document.getElementById("phone").value;
      const lang = localStorage.getItem("lang") || "kk";

      if (!/^(?=.*[a-zA-Z])(?=.*\d).{6,}$/.test(pass1)) {
        alert(texts[lang].password_error);
        return;
      }
      if (pass1 !== pass2) {
        alert(texts[lang].password_match);
        return;
      }

      fetch("/reset_password", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone, password: pass1 })
      })
      .then(res => res.json())
      .then(data => {
        const saveError = document.getElementById("save-error");
        saveError.classList.add("hidden");

        if (data.ok) {
          document.getElementById("password-section").classList.add("hidden");
          document.getElementById("success-section").classList.remove("hidden");
        } else {
          saveError.innerText = data.msg || "“ö“±–ø–∏—è—Å”©–∑ –∂–∞“£–∞—Ä—Ç—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã";
          saveError.classList.remove("hidden");
        }
      });
    }

    window.onload = () => {
      const lang = localStorage.getItem("lang") || "kk";
      setLanguage(lang);

      const phoneInput = document.getElementById("phone");
      let prevValue = "";
      let prevCursorPos = 0;

      phoneInput.addEventListener("keydown", function (e) {
        prevValue = this.value;
        prevCursorPos = this.selectionStart;

        if (e.key === "Backspace" && this.selectionStart <= 4) {
          e.preventDefault();
          return;
        }

        const charBefore = this.value.charAt(this.selectionStart - 1);
        if (e.key === "Backspace" && [' ', ')', '('].includes(charBefore)) {
          e.preventDefault();
          const pos = this.selectionStart;
          this.value = this.value.slice(0, pos - 2) + this.value.slice(pos);
          this.setSelectionRange(pos - 2, pos - 2);
        }

        if (!/[0-9]/.test(e.key) &&
          !["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"].includes(e.key)) {
          e.preventDefault();
        }
      });

      phoneInput.addEventListener("input", function () {
        let digits = this.value.replace(/\D/g, '');
        if (!digits || digits === '7') {
          this.value = '+7 ';
          this.setSelectionRange(this.value.length, this.value.length);
          return;
        }

        if (digits.startsWith('7')) digits = digits.slice(1);
        if (digits.length > 10) digits = digits.slice(0, 10);

        let formatted = '+7';
        if (digits.length > 0) formatted += ' (' + digits.slice(0, 3);
        if (digits.length >= 3) formatted += ') ' + digits.slice(3, 6);
        if (digits.length >= 6) formatted += ' ' + digits.slice(6, 8);
        if (digits.length >= 8) formatted += ' ' + digits.slice(8, 10);

        this.value = formatted;

        const diff = this.value.length - prevValue.length;
        const newPos = prevCursorPos + diff;
        this.setSelectionRange(newPos, newPos);
      });

      phoneInput.addEventListener("focus", function () {
        setTimeout(() => {
          if (this.selectionStart < 4) {
            this.setSelectionRange(this.value.length, this.value.length);
          }
        }, 0);
      });
    };
  </script>
</body>
</html>
