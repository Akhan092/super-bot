<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen px-6">
  <div class="bg-white p-6 sm:p-8 rounded-xl shadow max-w-md w-full mx-auto text-base sm:text-lg">
    <!-- üî§ –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à -->
    <div class="flex justify-end text-sm mb-4">
      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
      <span class="mx-1 text-gray-400">/</span>
      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
    </div>

    <h2 id="title" class="text-2xl font-bold mb-4 text-center">“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</h2>

    <form id="reset-form" onsubmit="return validateCode(event)">
      <label id="label-phone" class="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ</label>
      <input id="phone" value="+7 " maxlength="18" required class="w-full p-2 border rounded mb-3" />

      <div id="send-button-block">
        <button type="button" onclick="sendSMS()" class="w-full bg-blue-600 text-white py-2 rounded">–ö–æ–¥ –∂—ñ–±–µ—Ä—É</button>
      </div>

      <div class="hidden" id="sms-code-block">
        <label id="label-code" class="block text-sm mb-1">SMS –∫–æ–¥</label>
        <input id="sms_code" maxlength="6" class="w-full p-2 border rounded mb-3" inputmode="numeric" />
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–ö–æ–¥—Ç—ã —Ç–µ–∫—Å–µ—Ä—É</button>
      </div>
    </form>

    <div class="hidden" id="password-section">
      <h3 class="text-lg font-semibold mb-3">–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑</h3>
      <div class="mb-3 relative">
        <input id="new_password" type="password" placeholder="–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑" class="w-full p-2 border rounded pr-10" />
        <button type="button" onclick="togglePassword('new_password')" class="absolute inset-y-0 right-3 text-gray-500">üëÅÔ∏è</button>
        <p class="text-sm text-gray-500 mt-1">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä</p>
      </div>
      <div class="mb-3 relative">
        <input id="repeat_password" type="password" placeholder="“ö–∞–π—Ç–∞ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" class="w-full p-2 border rounded pr-10" />
        <button type="button" onclick="togglePassword('repeat_password')" class="absolute inset-y-0 right-3 text-gray-500">üëÅÔ∏è</button>
        <p class="text-sm text-gray-500 mt-1">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä</p>
      </div>
      <button onclick="saveNewPassword()" class="bg-blue-600 text-white w-full py-2 rounded">–°–∞“õ—Ç–∞—É</button>
    </div>

    <div class="hidden text-center mt-4" id="success-section">
      <p class="text-green-600 font-semibold">“ö“±–ø–∏—è—Å”©–∑ —Å”ô—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã ‚úÖ</p>
      <a href="/" class="inline-block mt-3 bg-green-600 text-white py-2 px-4 rounded">–ö—ñ—Ä—É</a>
    </div>
  </div>

  <script>
    const texts = {
      kk: {
        title: "“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É",
        "label-phone": "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ",
        "label-code": "SMS –∫–æ–¥",
        error_code: "–ö–æ–¥ –¥“±—Ä—ã—Å –µ–º–µ—Å",
        password_error: "“ö“±–ø–∏—è—Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞, ”ô—Ä—ñ–ø –ø–µ–Ω —Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫",
        password_match: "“ö“±–ø–∏—è—Å”©–∑–¥–µ—Ä —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π–¥—ñ"
      },
      ru: {
        title: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è",
        "label-phone": "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "label-code": "–°–ú–° –∫–æ–¥",
        error_code: "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥",
        password_error: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã",
        password_match: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("title").innerText = t.title;
      document.getElementById("label-phone").innerText = t["label-phone"];
      document.getElementById("label-code").innerText = t["label-code"];
      localStorage.setItem("lang", lang);
    }

    function togglePassword(id) {
      const field = document.getElementById(id);
      field.type = field.type === "password" ? "text" : "password";
    }

    window.onload = () => {
      const lang = localStorage.getItem("lang") || "kk";
      setLanguage(lang);
      const phoneInput = document.getElementById("phone");
      phoneInput.value = '+7 ';
      phoneInput.addEventListener("keydown", function (e) {
        if (e.key === "Backspace" && this.selectionStart <= 3) {
          e.preventDefault();
        }
        if (!/[0-9]/.test(e.key) && !["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"].includes(e.key)) {
          e.preventDefault();
        }
      });
	  
    phoneInput.addEventListener("keydown", function (e) {
		prevValue = this.value;
		prevCursorPos = this.selectionStart;

		// +7 ”©—à–ø–µ—É—ñ –∫–µ—Ä–µ–∫
		if (e.key === "Backspace" && this.selectionStart <= 4) {
			e.preventDefault();
			return;
		}

		// –ë–æ—Å —Å–∏–º–≤–æ–ª ( ) –∞—Ä—Ç—ã–Ω–¥–∞ —Ç“±—Ä—Å–∞ ‚Äî –±—ñ—Ä–≥–µ ”©—à—ñ—Ä–µ–º—ñ–∑
		const c = this.value.charAt(this.selectionStart - 1);
		if (e.key === "Backspace" && [' ', ')', '('].includes(c)) {
			e.preventDefault();
			const pos = this.selectionStart;
			this.value = this.value.slice(0, pos - 2) + this.value.slice(pos);
			this.setSelectionRange(pos - 2, pos - 2);
		}
    });
    
    function sendSMS() {
      const phone = document.getElementById("phone").value;
      fetch("/send_code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone: phone, mode: "reset" })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg || "–ö–æ–¥ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ");
        document.getElementById("sms-code-block").classList.remove("hidden");
        document.getElementById("send-button-block").classList.add("hidden");
      });
    }

    function validateCode(e) {
      e.preventDefault();
      const code = document.getElementById("sms_code").value;
      const phone = document.getElementById("phone").value;
      const lang = localStorage.getItem("lang") || "kk";

      if (!/^\d{6}$/.test(code)) {
        alert(texts[lang].error_code);
        return;
      }

      fetch("/verify_code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone, code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("reset-form").classList.add("hidden");
          document.getElementById("password-section").classList.remove("hidden");
        } else {
          alert(texts[lang].error_code);
        }
      });
    }

    function saveNewPassword() {
      const pass1 = document.getElementById("new_password").value;
      const pass2 = document.getElementById("repeat_password").value;
      const phone = document.getElementById("phone").value;
      const lang = localStorage.getItem("lang") || "kk";

      if (!/^(?=.*[a-zA-Z])(?=.*\d).{6,}$/.test(pass1)) {
        alert(texts[lang].password_error);
        return;
      }
      if (pass1 !== pass2) {
        alert(texts[lang].password_match);
        return;
      }

      fetch("/reset_password", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone, password: pass1 })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          document.getElementById("password-section").classList.add("hidden");
          document.getElementById("success-section").classList.remove("hidden");
        } else {
          alert(data.msg || "“ö–∞—Ç–µ");
        }
      });
    }
  </script>
</body>
</html>
