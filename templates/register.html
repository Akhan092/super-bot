<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢—ñ—Ä–∫–µ–ª—É</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 sm:p-8 rounded-xl shadow w-full max-w-md relative scale-105 lg:scale-110 text-base sm:text-lg">

    <!-- üî§ –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à -->
    <div class="absolute top-0 right-0 mt-2 mr-2 text-sm">
      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button> /
      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
    </div>

    <h2 id="title" class="text-2xl font-bold mb-4 text-center">–¢—ñ—Ä–∫–µ–ª—É</h2>

    <!-- üì© SMS –∞—Ä“õ—ã–ª—ã —Ç—ñ—Ä–∫–µ–ª—É -->
    <form id="register-form" method="post" onsubmit="return validateForm(event)">
      <div class="mb-3">
        <label id="label-name" class="block text-sm mb-1">–ê—Ç—ã</label>
        <input name="first_name" id="first_name" placeholder="–ê—Ç—ã“£—ã–∑" required class="w-full p-2 border rounded" />
      </div>
      <div class="mb-3">
        <label id="label-phone" class="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ</label>
        <input id="phone" name="phone" placeholder="+7 (707) 123 45 67" value="+7 " maxlength="18" required class="w-full p-2 border rounded" />
      </div>

      <div class="mb-3" id="send-button-block">
        <button type="button" onclick="sendSMS()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">–¢—ñ—Ä–∫–µ–ª—É</button>
      </div>

      <div class="mb-3 hidden" id="sms-code-block">
        <label id="label-code" class="block text-sm mb-1">SMS –∫–æ–¥</label>
        <input id="sms_code" name="sms_code" placeholder="–ö–æ–¥" class="w-full p-2 border rounded" />
      </div>

      <div class="mb-4 hidden" id="final-submit-block">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded w-full">–¢—ñ—Ä–∫–µ–ª—É</button>
      </div>
    </form>

    <!-- üîê “ö“±–ø–∏—è—Å”©–∑ –µ–Ω–≥—ñ–∑—É –±”©–ª—ñ–º—ñ -->
    <div class="hidden" id="password-section">
      <h3 class="text-lg font-semibold mb-3">“ö“±–ø–∏—è—Å”©–∑ –æ—Ä–Ω–∞—Ç—É</h3>
      <div class="mb-3">
        <div class="relative">
          <input id="new_password" type="password" placeholder="–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑" class="w-full p-2 border rounded" />
          <button type="button" onclick="toggleNewPassword('new_password')" class="absolute inset-y-0 right-2 flex items-center text-gray-500">üëÅÔ∏è</button>
        </div>
        <p class="text-gray-500 text-sm mt-1">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä</p>
      </div>
      <div class="mb-3">
        <div class="relative">
          <input id="repeat_password" type="password" placeholder="“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑" class="w-full p-2 border rounded" />
          <button type="button" onclick="toggleNewPassword('repeat_password')" class="absolute inset-y-0 right-2 flex items-center text-gray-500">üëÅÔ∏è</button>
        </div>
        <p class="text-gray-500 text-sm mt-1">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –º–∏–Ω 6 –±—É–∫–≤ a-z –∏ 1 —Ü–∏—Ñ—Ä</p>
      </div>
      <button onclick="savePassword()" class="bg-blue-600 text-white w-full py-2 rounded">–°–∞“õ—Ç–∞—É</button>
    </div>

    <!-- ‚úÖ –°”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ–ª—É -->
    <div class="hidden text-center mt-4" id="success-section">
      <p class="text-green-600 font-semibold">–°—ñ–∑ —Å”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ–ª–¥—ñ“£—ñ–∑ ‚úÖ</p>
      <a href="/" class="inline-block mt-3 bg-green-600 text-white py-2 px-4 rounded">–ö—ñ—Ä—É</a>
    </div>
  </div>

  <script>
    const texts = {
      kk: {
        title: "–¢—ñ—Ä–∫–µ–ª—É",
        "label-name": "–ê—Ç—ã",
        "label-phone": "–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ",
        "label-code": "SMS –∫–æ–¥",
        "submit-initial": "–¢—ñ—Ä–∫–µ–ª—É",
        "submit-final": "–¢—ñ—Ä–∫–µ–ª—É",
        success: "SMS –∫–æ–¥ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ",
        error_code: "–ö–æ–¥ –¥“±—Ä—ã—Å –µ–º–µ—Å",
        error_form: "–ê—Ç—ã –º–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ –¥“±—Ä—ã—Å —Ç–æ–ª—Ç—ã—Ä—ã–ª—É—ã –∫–µ—Ä–µ–∫",
        password_error: "“ö“±–ø–∏—è—Å”©–∑ –∫–µ–º—ñ–Ω–¥–µ 6 —Ç–∞“£–±–∞–¥–∞–Ω —Ç“±—Ä—É—ã –∂”ô–Ω–µ ”ô—Ä—ñ–ø –ø–µ–Ω —Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫",
        password_match: "“ö“±–ø–∏—è—Å”©–∑–¥–µ—Ä —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π–¥—ñ"
      },
      ru: {
        title: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
        "label-name": "–ò–º—è",
        "label-phone": "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
        "label-code": "–ö–æ–¥ –∏–∑ SMS",
        "submit-initial": "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
        "submit-final": "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é",
        success: "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ SMS",
        error_code: "–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π",
        error_form: "–ò–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ",
        password_error: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤, —Å –±—É–∫–≤–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏",
        password_match: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("title").innerText = t.title;
      document.getElementById("label-name").innerText = t["label-name"];
      document.getElementById("label-phone").innerText = t["label-phone"];
      document.getElementById("label-code").innerText = t["label-code"];
      document.querySelector("#send-button-block button").innerText = t["submit-initial"];
      document.querySelector("#final-submit-block button").innerText = t["submit-final"];
      localStorage.setItem('lang', lang);
    }

    window.onload = () => {
      const lang = localStorage.getItem("lang") || "kk";
      setLanguage(lang);
    };

    document.getElementById("phone").addEventListener("input", function () {
      let digits = this.value.replace(/\D/g, '');
      if (digits.startsWith('7')) digits = digits.slice(1);
      if (digits.length > 10) digits = digits.slice(0, 10);

      let formatted = '+7';
      if (digits.length > 0) formatted += ' (' + digits.slice(0, 3);
      if (digits.length >= 3) formatted += ') ' + digits.slice(3, 6);
      if (digits.length >= 6) formatted += ' ' + digits.slice(6, 8);
      if (digits.length >= 8) formatted += ' ' + digits.slice(8, 10);

      this.value = formatted;
    });

    function sendSMS() {
      const phone = document.getElementById("phone").value;
      const name = document.getElementById("first_name").value;
      const lang = localStorage.getItem("lang") || "kk";
      if (!name.trim() || phone.length !== 18) {
        alert(texts[lang].error_form);
        return;
      }

      fetch("/send_code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "phone=" + encodeURIComponent(phone)
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg || texts[lang].success);
        document.getElementById("sms-code-block").classList.remove("hidden");
        document.getElementById("final-submit-block").classList.remove("hidden");
        document.getElementById("send-button-block").classList.add("hidden");
      })
      .catch(err => {
        console.error(err);
        alert("“ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã");
      });
    }

    function validateForm(event) {
      event.preventDefault();
      const code = document.getElementById("sms_code").value;
      const lang = localStorage.getItem("lang") || "kk";

      if (!/^\d{6}$/.test(code)) {
        alert(texts[lang].error_code);
        return false;
      }

      // ‚úÖ –ö–æ–¥ –¥“±—Ä—ã—Å –±–æ–ª—Å–∞ “ì–∞–Ω–∞ –ø–∞—Ä–æ–ª—å –µ–Ω–≥—ñ–∑—É–≥–µ —Ä“±“õ—Å–∞—Ç
      document.getElementById("register-form").classList.add("hidden");
      document.getElementById("password-section").classList.remove("hidden");
      return false;
    }

    function savePassword() {
      const pass1 = document.getElementById("new_password").value;
      const pass2 = document.getElementById("repeat_password").value;
      const lang = localStorage.getItem("lang") || "kk";

      if (!/^(?=.*[a-zA-Z])(?=.*\d).{6,}$/.test(pass1)) {
        alert(texts[lang].password_error);
        return;
      }
      if (pass1 !== pass2) {
        alert(texts[lang].password_match);
        return;
      }

      document.getElementById("password-section").classList.add("hidden");
      document.getElementById("success-section").classList.remove("hidden");
    }

    function toggleNewPassword(id) {
      const field = document.getElementById(id);
      field.type = field.type === 'password' ? 'text' : 'password';
    }
  </script>
</body>
</html>
