<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SuperBOT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

 	 <!-- üîù –ñ–æ“ì–∞—Ä“ì—ã –ø–∞–Ω–µ–ª—å -->
	<div id="top-bar" class="fixed top-0 left-0 right-0 bg-white shadow z-50 p-4 flex justify-between items-center text-sm sm:text-base px-4 sm:px-8">
	  <!-- ‚ò∞ –ì–∞–º–±—É—Ä–≥–µ—Ä + –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à -->
	  <div class="flex items-center gap-4">
	    <!-- ‚ò∞ –ì–∞–º–±—É—Ä–≥–µ—Ä —Ç–µ–∫ –º–æ–±–∞–π–ª–¥–∞ -->
	    <button onclick="toggleMobileMenu()" class="sm:hidden text-2xl">‚ò∞</button>
	    <!-- –¢—ñ–ª —Ç–∞“£–¥–∞“ì—ã—à ‚Äì –±–∞—Ä–ª—ã“õ “õ“±—Ä—ã–ª“ì—ã–¥–∞ -->
	    <div class="flex space-x-2">
	      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
	      <span>/</span>
	      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
	    </div>
	  </div>
		
	  <!-- üî≤ Overlay -->
	  <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-[40] sm:hidden" onclick="toggleMobileMenu()"></div>
	
	  


		
	  <!-- –®—ã“ì—É –±–∞—Ç—ã—Ä–º–∞—Å—ã -->
	  <a id="logout-button" href="/" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">–®—ã“ì—É</a>
	</div>	


	<!-- ‚úÖ –°–æ–ª –∂–∞“õ –º”ô–∑—ñ—Ä (—Ç–µ–∫ sm –∂”ô–Ω–µ –æ–¥–∞–Ω “Ø–ª–∫–µ–Ω “õ“±—Ä—ã–ª“ì—ã–ª–∞—Ä–¥–∞ “ì–∞–Ω–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ) -->
	<aside class="hidden sm:block fixed top-16 left-0 w-1/6 h-full bg-white shadow-md px-4 py-6 z-40">
	  <h2 class="text-lg font-semibold mb-4">üìÅ –ú–µ–Ω—é</h2>
	  <ul class="space-y-2 text-sm">
	    <li><a id="menu-link" href="#" class="text-blue-600 font-medium">–ú–æ–∏ –º–∞–≥–∞–∑–∏–Ω—ã</a></li>
	    <li><a id="menu-nakl" href="#" class="text-blue-600 font-medium">Kaspi –Ω–∞–∫–ª–∞–¥–Ω–æ–π–ª–∞—Ä—ã–Ω —à—ã“ì–∞—Ä—É</a></li>
	  </ul>

	</aside>
	
	<!-- üì¶ –ö–æ–Ω—Ç–µ–Ω—Ç (–º–æ–±–∏–ª–¥–µ —Ç–æ–ª—ã“õ –µ–Ω, sm+ “õ“±—Ä—ã–ª“ì—ã–ª–∞—Ä–¥–∞ –æ“£“ì–∞ —ã“ì—ã—Å“õ–∞–Ω) -->
	<main class="w-full sm:ml-[16.67%] sm:w-[83.33%] pt-24 px-4 sm:px-8">
	  
	  <!-- üëã –°”ô–ª–µ–º -->
	  <div class="flex justify-center mb-6">
	    <h1 id="greeting" data-name="{{ name }}"
	        class="text-3xl sm:text-4xl font-bold text-gray-800 text-center">
	      –°”ô–ª–µ–º, {{ name }}
	    </h1>
	  </div>
	
	  <!-- üè™ –ú–∞–≥–∞–∑–∏–Ω —Ç—ñ–∑—ñ–º—ñ -->
	<div id="section-shops" class="flex justify-center">
	  <div class="bg-white shadow rounded-xl w-full max-w-6xl p-4 sm:p-6">
	    
	    <!-- üîù –¢–∞“õ—ã—Ä—ã–ø –ø–µ–Ω –∫–Ω–æ–ø–∫–∞ -->
	    <div class="flex flex-wrap justify-between items-center gap-2 mb-6">
	      <h2 id="store-title" class="text-lg sm:text-xl font-semibold text-gray-800">
	        –ú–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ“£—ñ–∑
	      </h2>
	      <button onclick="openModal()" id="add-button"
	              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm whitespace-nowrap">
	        + –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É
	      </button>
	    </div>
	
	    <!-- üß© –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä—ã -->
	    <div id="store-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
	      {% for shop in shops %}
	      <div class="border rounded-xl shadow p-4 bg-white relative">
	        <h3 class="text-lg font-bold mb-1">{{ shop.shop_name }}</h3>
	        <p class="text-xs text-gray-500">ID: {{ shop.merchant_id }}</p>
	        {% set lang = request.cookies.get("lang") or "kk" %}
	        {% set expires = shop.created_at + timedelta(hours=72) %}
	        {% set days_left = ((shop.created_at + timedelta(hours=72)) - datetime.utcnow()).days %}
	        <p class="text-xs text-blue-600 mt-1 expires-section" 
	           data-created="{{ shop.created_at.isoformat() }}">
	        </p>
	
	        <button id="delete-button-{{ loop.index }}"
	                onclick="deleteStore('{{ shop.shop_name }}', this)"
	                class="absolute top-2 right-2 text-sm text-red-500 hover:underline">
	        </button>
	      </div>
	      {% endfor %}
	    </div>
	
	  </div>
	</div>
	
	<!-- ‚úÖ Kaspi –Ω–∞–∫–ª–∞–¥–Ω–æ–π —à—ã“ì–∞—Ä—É –±”©–ª—ñ–º—ñ –ë”®–õ–ï–ö —Ç“±—Ä -->
	<div id="section-nakl" class="hidden mt-10 bg-white shadow rounded-xl w-full max-w-3xl mx-auto p-6">
	  <h2 class="text-xl font-semibold mb-4">üßæ –ú–∞–≥–∞–∑–∏–Ω —Ç–∞“£–¥–∞“£—ã–∑</h2>
	  <select id="nakl-shop-select" class="border p-2 rounded mb-6 w-full">
	    <option disabled selected>–ú–∞–≥–∞–∑–∏–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</option>
	    {% for shop in shops %}
	    <option value="{{ shop.shop_name }}">{{ shop.shop_name }}</option>
	    {% endfor %}
	  </select>
	
	  <h2 class="text-xl font-semibold mb-3">‚öôÔ∏è –†–µ–∂–∏–º —Ç–∞“£–¥–∞“£—ã–∑</h2>
	  <div class="space-y-2 mb-6">
	    <label class="block">
	      <input type="radio" name="nakl-mode" value="upakovka" class="mr-2">
	      –£–ø–∞–∫–æ–≤–∫–∞–¥–∞“ì—ã –∂–∞“£–∞ –∑–∞–∫–∞–∑–¥–∞—Ä–¥—ã —à—ã“ì–∞—Ä—É
	    </label>
	    <label class="block">
	      <input type="radio" name="nakl-mode" value="full" class="mr-2">
	      –ë–∞—Ä–ª—ã“õ –∑–∞–∫–∞–∑–¥–∞—Ä–¥—ã —à—ã“ì–∞—Ä—É (–£–ø–∞–∫–æ–≤–∫–∞ + –ü–µ—Ä–µ–¥–∞—á–∞)
	    </label>
	  </div>
	
	  <button id="generate-nakl-button" class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700">
	    üìÑ –ù–∞–∫–ª–∞–¥–Ω–æ–π —à—ã“ì–∞—Ä—É
	  </button>
	</div>

		    
<!-- üì± –ú–æ–±–∏–ª—å–¥—ñ –º–µ–Ω—é -->
	  <div id="mobile-menu" class="hidden absolute top-[64px] left-0 right-0 bg-white z-40 sm:hidden border-t border-gray-300 shadow-md min-h-[calc(100vh-64px)] px-4 py-6">
		  <ul class="space-y-4">
		    <li><a id="mobile-menu-link" href="#" class="text-blue-600 font-medium">üìÅ –ú–æ–∏ –º–∞–≥–∞–∑–∏–Ω—ã</a></li>
		    <li><a id="mobile-menu-nakl" href="#" class="text-blue-600 font-medium">üì¶ Kaspi –Ω–∞–∫–ª–∞–¥–Ω–æ–π–ª–∞—Ä—ã–Ω —à—ã“ì–∞—Ä—É</a></li>
		  </ul>
		</div>
	  </div>
	</div>



  <!-- ü™ü –ú–æ–¥–∞–ª -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-400 hover:text-black text-xl">&times;</button>
      <h2 id="modal-title" class="text-xl font-bold text-center mb-4">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</h2>

      <div class="flex justify-center items-center space-x-2 mb-4">
        <img src="https://upload.wikimedia.org/wikipedia/ru/a/aa/Logo_of_Kaspi_bank.png" alt="Kaspi"
             class="w-10 h-10 object-contain">
        <span class="text-lg font-semibold text-gray-800">Kaspi</span>
      </div>

      <p id="email-label" class="text-center text-sm text-gray-500 mb-2">–ø–æ email</p>
      <input id="store-email" type="email" placeholder="Email"
             class="border p-2 rounded w-full mb-3" />

      <div class="relative mb-1">
        <input id="store-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
               class="border p-2 rounded w-full pr-10" />
        <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-2 flex items-center text-gray-500">
          üëÅÔ∏è
        </button>
      </div>

      <p id="store-error" class="text-sm text-red-600 mt-1 mb-3"></p>

      <button id="modal-add-button"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
        –î–æ–±–∞–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- ‚úÖ JavaScript -->
  <script>
    // üü¢ –ú–Ü–ù–ï –û–°–´ –ñ–ï–†–ì–ï “ö–û–ô–´“¢–´–ó
    let deleteShopName = "";
    let deleteShopElement = null;
	  
    const texts = {
      kk: {
        logout: "–®—ã“ì—É",
        greeting: "–°”ô–ª–µ–º, ",
        store_title: "–ú–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ“£—ñ–∑",
        add_button: "+ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_title: "–ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_email_label: "email –∞—Ä“õ—ã–ª—ã",
        modal_add: "“ö–æ—Å—É",
	loading: "“ö–æ—Å—ã–ª—É–¥–∞...",
	duplicate_shop: "‚ö†Ô∏è –ë“±–ª Kaspi –º–∞–≥–∞–∑–∏–Ω –±—ñ–∑–¥—ñ“£ –∂“Ø–π–µ–¥–µ –±“±—Ä—ã–Ω —Ç—ñ—Ä–∫–µ–ª–≥–µ–Ω",
	invalid_auth: "‚ùå –õ–æ–≥–∏–Ω –Ω–µ–º–µ—Å–µ –ø–∞—Ä–æ–ª—å “õ–∞—Ç–µ.",
	expires_label: "üïí –ê–∫—Ç–∏–≤—Ç—ñ–ª—ñ–∫ –º–µ—Ä–∑—ñ–º—ñ:",
    	left_label: "‚è≥ “ö–∞–ª–¥—ã:",
    	days_unit: "–∫“Ø–Ω",
	menu_my_shops: "–ú–µ–Ω—ñ“£ –º–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ–º",
	menu_nakl: "Kaspi –Ω–∞–∫–ª–∞–¥–Ω–æ–π–ª–∞—Ä—ã–Ω –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —à—ã“ì–∞—Ä—É",
	      
      },
      ru: {
        logout: "–í—ã–π—Ç–∏",
        greeting: "–ü—Ä–∏–≤–µ—Ç, ",
        store_title: "–í–∞—à–∏ –º–∞–≥–∞–∑–∏–Ω—ã",
        add_button: "+ –î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω",
        modal_title: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",
        modal_email_label: "–ø–æ email",
        modal_add: "–î–æ–±–∞–≤–∏—Ç—å",
	loading: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...",
	duplicate_shop: "‚ö†Ô∏è –≠—Ç–æ—Ç Kaspi –º–∞–≥–∞–∑–∏–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ",
	invalid_auth: "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.",
	expires_label: "üïí –ê–∫—Ç–∏–≤–µ–Ω –¥–æ:",
    	left_label: "‚è≥ –û—Å—Ç–∞–ª–æ—Å—å:",
    	days_unit: "–¥–Ω–µ–π",
	menu_my_shops: "–ú–æ–∏ –º–∞–≥–∞–∑–∏–Ω—ã",
	menu_nakl: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö Kaspi"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("logout-button").innerText = t.logout;
      document.getElementById("store-title").innerText = t.store_title;
      document.getElementById("add-button").innerText = t.add_button;
      document.getElementById("modal-title").innerText = t.modal_title;
      document.getElementById("email-label").innerText = t.modal_email_label;
      document.getElementById("modal-add-button").innerText = t.modal_add;
      document.getElementById("menu-link").innerText = t.menu_my_shops;
      document.getElementById("mobile-menu-link").innerText = t.menu_my_shops;
      document.getElementById("menu-nakl").innerText = t.menu_nakl;
      document.getElementById("mobile-menu-nakl").innerText = "üì¶ " + t.menu_nakl;

      // üîÅ "–ò”ô / –ñ–æ“õ" –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä—ã
      document.getElementById("confirm-yes").innerText = (lang === "kk") ? "–ò”ô" : "–î–∞";
      document.getElementById("confirm-no").innerText = (lang === "kk") ? "–ñ–æ“õ" : "–ù–µ—Ç";
      window.currentLang = lang;
       // üîÅ –°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ
      document.getElementById("confirm-question").innerHTML =
	  (lang === "kk")
	    ? `<span id="confirm-shop-name"></span> –º–∞–≥–∞–∑–∏–Ω—ñ–Ω ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?`
	    : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω <span id="confirm-shop-name"></span>?`;

      // üîÅ –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä—ã–Ω–¥–∞“ì—ã "”®—à—ñ—Ä—É" –∫–Ω–æ–ø–∫–∞–ª–∞—Ä—ã–Ω –∂–∞“£–∞—Ä—Ç—É
      const deleteButtons = document.querySelectorAll("button[id^='delete-button']");
      deleteButtons.forEach(btn => {
	    btn.innerText = (lang === "kk") ? "”®—à—ñ—Ä—É" : "–£–¥–∞–ª–∏—Ç—å";
	  });
    
      const name = document.getElementById("greeting").getAttribute("data-name");
      document.getElementById("greeting").innerText = t.greeting + name;

      localStorage.setItem("lang", lang);
      document.cookie = `lang=${lang}; path=/`;

      // üîÅ expires-section –∂–∞“£–∞—Ä—Ç—É (–ê–∫—Ç–∏–≤–µ–Ω –¥–æ, –û—Å—Ç–∞–ª–æ—Å—å)
      const now = new Date();
      document.querySelectorAll(".expires-section").forEach(el => {
          const createdAt = new Date(el.dataset.created);
	  const expiresAt = new Date(createdAt.getTime() + 72 * 60 * 60 * 1000);
	  const daysLeft = Math.max(1, Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24)));
	
	  const dateFormatted = expiresAt.toLocaleString(lang === "kk" ? "kk-KZ" : "ru-RU", {
	    day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit"
	  });
	
	  let leftText = "";
	  if (lang === "kk") {
	    leftText = `‚è≥ ${daysLeft} –∫“Ø–Ω “õ–∞–ª–¥—ã`;
	  } else {
	    leftText = `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} ${texts[lang].days_unit}`;
	  }
	  const expText = `${texts[lang].expires_label} ${dateFormatted}<br>${leftText}`;

	  el.innerHTML = expText;
      });

    }

    function openModal() {
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("store-error").innerText = "";
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("store-error").innerText = "";
    }

    function togglePassword() {
      const input = document.getElementById("store-password");
      input.type = input.type === "password" ? "text" : "password";
    }

    function renderStoreCard(shop) {
      const card = document.createElement("div");
      card.className = "border p-4 rounded shadow bg-white relative";
    
      const createdAt = new Date(shop.created_at).toLocaleString("kk-KZ", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    
      card.innerHTML = `
	  <h3 class="text-lg font-bold mb-1">${shop.name || shop.shop_name}</h3>
	  <p class="text-sm text-gray-600">–õ–æ–≥–∏–Ω: ${shop.login}</p>
	  <p class="text-sm text-red-600">–ü–∞—Ä–æ–ª—å: ${shop.password}</p>
	  <p class="text-xs text-blue-500 mt-1">–¢—ñ—Ä–∫–µ–ª–≥–µ–Ω: ${createdAt}</p>
	  <button onclick="deleteStore('${shop.name || shop.shop_name}', this)"
	          class="absolute top-2 right-2 text-sm text-red-500 hover:underline">
	    ”®—à—ñ—Ä—É
	  </button>
	`;


      document.getElementById("store-list").appendChild(card);
    }




    function confirmDelete() {
	  const phone = localStorage.getItem("user_phone");
	
	  fetch("/delete_kaspi_shop", {
	    method: "POST",
	    headers: { "Content-Type": "application/x-www-form-urlencoded" },
	    body: new URLSearchParams({ name: deleteShopName, phone })
	  })
	    .then((res) => res.json())
	    .then((data) => {
	      if (data.ok) {
	        deleteShopElement.closest(".border").remove();
	      } else {
	        alert("“ö–∞—Ç–µ: " + (data.msg || "–ú–∞–≥–∞–∑–∏–Ω ”©—à—ñ—Ä—ñ–ª–º–µ–¥—ñ"));
	      }
	    })
	    .catch((err) => {
	      console.error(err);
	      alert("‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.");
	    })
	    .finally(() => {
	      document.getElementById("confirm-modal").classList.add("hidden");
	      deleteShopName = "";
	      deleteShopElement = null;
	    });
	}
	
	function cancelDelete() {
	  document.getElementById("confirm-modal").classList.add("hidden");
	  deleteShopName = "";
	  deleteShopElement = null;
	}



    window.onload = function () {
	  const phone = localStorage.getItem("user_phone");
	  if (!phone) {
	    window.location.href = "/";
	    return;
	  }
	
	  const url = new URL(window.location.href);
	  if (!url.searchParams.has("phone")) {
	    url.searchParams.set("phone", phone);
	    window.location.href = url.toString();
	    return;
	  }
	
	  // üî§ –¢—ñ–ª–¥—ñ –∞–Ω—ã“õ—Ç–∞—É
	  const savedLang = localStorage.getItem("lang");
	  const browserLang = navigator.language.startsWith("ru") ? "ru" : "kk";
	  const lang = savedLang || browserLang;
	
	  setLanguage(lang); // üü¢ –ú”ô—Ç—ñ–Ω–¥–µ—Ä–¥—ñ –¥“±—Ä—ã—Å —Ç—ñ–ª–¥–µ –∫”©—Ä—Å–µ—Ç—É
	};

 
    function editStore(name) {
      alert(`"${name}" –º–∞–≥–∞–∑–∏–Ω—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É –ª–æ–≥–∏–∫–∞—Å—ã –∫–µ–π—ñ–Ω “õ–æ—Å—ã–ª–∞–¥—ã.`);
    }

    document.getElementById("modal-add-button").addEventListener("click", async () => {
	  const login = document.getElementById("store-email").value.trim();
	  const password = document.getElementById("store-password").value.trim();
	  const errorLabel = document.getElementById("store-error");
	  const button = document.getElementById("modal-add-button");
	  const rawPhone = localStorage.getItem("user_phone");
	
	  if (!login || !password || !rawPhone) {
	    errorLabel.innerText = "‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑.";
	    return;
	  }
	
	  const phone = rawPhone;
	  const lang = window.currentLang || localStorage.getItem("lang") || "kk";  // —Ç—ñ–ª –∞–Ω—ã“õ—Ç–∞—É
	  const loadingText = texts?.[lang]?.loading || "“ö–æ—Å—ã–ª—É–¥–∞..."; // —Ç—ñ–ª–≥–µ —Å–∞–π –º”ô—Ç—ñ–Ω
	
	  button.disabled = true;
	  button.innerHTML = `
	    <svg class="animate-spin h-4 w-4 mr-2 inline" viewBox="0 0 24 24">
	      <circle class="opacity-25" cx="12" cy="12" r="10"
	              stroke="currentColor" stroke-width="4" fill="none"></circle>
	      <path class="opacity-75" fill="currentColor"
	            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
	    </svg> ${loadingText}
	  `;
	
	  errorLabel.innerText = "";

  	  


	
	  try {
	    const res = await fetch("/add_kaspi_shop", {
	      method: "POST",
	      headers: { "Content-Type": "application/x-www-form-urlencoded" },
	      body: new URLSearchParams({ login, password, phone })
	    });
	
	    const data = await res.json();
	
	    if (
	      data.ok &&
	      data.name &&
	      data.login &&
	      data.password &&
	      data.created_at
	    ) {
	      document.getElementById("store-email").value = "";
	      document.getElementById("store-password").value = "";
	      closeModal();
	      window.location.reload();
	    } else {
	      // ‚ùó –Ω–∞“õ—Ç—ã “õ–∞–π “õ–∞—Ç–µ –µ–∫–µ–Ω—ñ–Ω –∞–Ω—ã“õ—Ç–∞–ø —à—ã“ì–∞—Ä—É
		if (data.msg && (data.msg.includes("–±“±—Ä—ã–Ω —Ç—ñ—Ä–∫–µ–ª–≥–µ–Ω") || data.msg.includes("–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"))) {
		  errorLabel.innerText = texts[lang]?.duplicate_shop || data.msg;
		} else if (data.msg && (data.msg.includes("–õ–æ–≥–∏–Ω") || data.msg.includes("–ø–∞—Ä–æ–ª—å"))) {
		  errorLabel.innerText = texts[lang]?.invalid_auth || data.msg;
		} else if (data.msg) {
		  errorLabel.innerText = "‚ùå " + data.msg;
		} else {
		  errorLabel.innerText = "‚ùå –ë–µ–ª–≥—ñ—Å—ñ–∑ “õ–∞—Ç–µ.";
		}
	    }
	
	  } catch (e) {
	    console.error(e);
	    errorLabel.innerText = "‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.";
	  } finally {
	    button.disabled = false;
	    button.innerText = "–î–æ–±–∞–≤–∏—Ç—å";
	  }
	});


	function deleteStore(name, el) {
	  deleteShopName = name;
	  deleteShopElement = el;
	
	  document.getElementById("confirm-shop-name").innerText = `"${name}"`;
	  document.getElementById("confirm-modal").classList.remove("hidden");
	}

	
	  function confirmDelete() {
	    const phone = localStorage.getItem("user_phone");
	
	    fetch("/delete_kaspi_shop", {
	      method: "POST",
	      headers: { "Content-Type": "application/x-www-form-urlencoded" },
	      body: new URLSearchParams({ name: deleteShopName, phone })
	    })
	      .then(res => res.json())
	      .then(data => {
	        if (data.ok) {
	          deleteShopElement.closest(".border").remove();
	        } else {
	          alert("“ö–∞—Ç–µ: " + (data.msg || "–ú–∞–≥–∞–∑–∏–Ω ”©—à—ñ—Ä—ñ–ª–º–µ–¥—ñ"));
	        }
	      })
	      .catch(err => {
	        console.error(err);
	        alert("‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.");
	      })
	      .finally(() => {
	        document.getElementById("confirm-modal").classList.add("hidden");
	        deleteShopName = "";
	        deleteShopElement = null;
	      });
	  }
	
	  function cancelDelete() {
	    document.getElementById("confirm-modal").classList.add("hidden");
	    deleteShopName = "";
	    deleteShopElement = null;
	  }

	  // üîΩ –ú–Ü–ù–ï –û–°–´ –ñ–ï–†–ì–ï “ö–û–ô–´“¢–´–ó
	  const lang = window.currentLang || localStorage.getItem("lang") || "kk";
	  const now = new Date();
	
	  document.querySelectorAll(".expires-section").forEach(el => {
	    const createdAt = new Date(el.dataset.created);
	    const expiresAt = new Date(createdAt.getTime() + 72 * 60 * 60 * 1000);
	    const daysLeft = Math.max(0, Math.floor((expiresAt - now) / (1000 * 60 * 60 * 24)));
	
	    const dateFormatted = expiresAt.toLocaleString(lang === "kk" ? "kk-KZ" : "ru-RU", {
	      day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit"
	    });
	
	    const expText = `${texts[lang].expires_label} ${dateFormatted}<br>${texts[lang].left_label} ${daysLeft} ${texts[lang].days_unit}`;
	    el.innerHTML = expText;
	  });
	  function toggleMobileMenu() {
		  const menu = document.getElementById("mobile-menu");
		  const topBar = document.getElementById("top-bar");
		
		  const isVisible = !menu.classList.contains("hidden");
		
		  if (!isVisible) {
		    // –º–µ–Ω—é –∞—à—ã–ª–∞–¥—ã
		    menu.classList.remove("hidden");
		    topBar.classList.add("z-[999]"); // “Ø—Å—Ç—ñ–Ω–µ —à—ã“ì–∞—Ä—É
		  } else {
		    // –º–µ–Ω—é –∂–∞–±—ã–ª–∞–¥—ã
		    menu.classList.add("hidden");
		    topBar.classList.remove("z-[999]");
		    topBar.classList.add("z-50");
		  }
		}


  </script>

<!-- üóëÔ∏è –ú–∞–≥–∞–∑–∏–Ω ”©—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞—É –º–æ–¥–∞–ª—ã -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full text-center">
    <p id="confirm-question" class="text-lg font-semibold mb-4">
	<!-- –ë“±–ª –∂–µ—Ä–≥–µ JavaScript –º”ô—Ç—ñ–Ω “õ–æ—è–¥—ã -->
    </p>
    <div class="flex justify-center space-x-4">
      <button id="confirm-yes" onclick="confirmDelete()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">–ò”ô</button>
      <button id="confirm-no" onclick="cancelDelete()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">–ñ–æ“õ</button>
    </div>
  </div>
</div>

</body>
</html>
