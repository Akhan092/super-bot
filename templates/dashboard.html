<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- üîù –¢—ñ–ª –º–µ–Ω —à—ã“ì—É -->
  <div class="bg-white shadow p-4 flex justify-between items-center">
    <div class="text-sm space-x-2">
      <button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
      <span>/</span>
      <button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
    </div>
    <a id="logout-button" href="/" class="text-sm bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">–®—ã“ì—É</a>
  </div>

  <!-- üëã –°”ô–ª–µ–º -->
  <div class="mt-10 text-center">
    <h1 id="greeting" data-name="{{ name }}" class="text-4xl font-bold text-gray-800">
      –°”ô–ª–µ–º, {{ name }}
    </h1>
  </div>

  <!-- üì¶ –ú–∞–≥–∞–∑–∏–Ω —Ç—ñ–∑—ñ–º—ñ -->
  <div class="mt-8 px-6 flex justify-center">
    <div class="bg-white shadow rounded-xl w-full max-w-6xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 id="store-title" class="text-xl font-semibold text-gray-800">–ú–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ“£—ñ–∑</h2>
        <button onclick="openModal()" id="add-button"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
          + –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É
        </button>
      </div>
      <div id="store-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <!-- –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä—ã –æ—Å—ã–Ω–¥–∞ —Ç“Ø—Å–µ–¥—ñ -->
      </div>
    </div>
  </div>

  <!-- ü™ü –ú–æ–¥–∞–ª -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-400 hover:text-black text-xl">&times;</button>
      <h2 id="modal-title" class="text-xl font-bold text-center mb-4">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</h2>

      <div class="flex justify-center items-center space-x-2 mb-4">
        <img src="https://upload.wikimedia.org/wikipedia/ru/a/aa/Logo_of_Kaspi_bank.png" alt="Kaspi"
             class="w-10 h-10 object-contain">
        <span class="text-lg font-semibold text-gray-800">Kaspi</span>
      </div>

      <p id="email-label" class="text-center text-sm text-gray-500 mb-2">–ø–æ email</p>
      <input id="store-email" type="email" placeholder="Email"
             class="border p-2 rounded w-full mb-3" />

      <div class="relative mb-4">
        <input id="store-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
               class="border p-2 rounded w-full pr-10" />
        <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-2 flex items-center text-gray-500">
          üëÅÔ∏è
        </button>
      </div>

      <button id="modal-add-button"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
        –î–æ–±–∞–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- ‚úÖ JavaScript -->
  <script>
    const texts = {
      kk: {
        logout: "–®—ã“ì—É",
        greeting: "–°”ô–ª–µ–º, ",
        store_title: "–ú–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ“£—ñ–∑",
        add_button: "+ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_title: "–ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_email_label: "email –∞—Ä“õ—ã–ª—ã",
        modal_add: "“ö–æ—Å—É"
      },
      ru: {
        logout: "–í—ã–π—Ç–∏",
        greeting: "–ü—Ä–∏–≤–µ—Ç, ",
        store_title: "–í–∞—à–∏ –º–∞–≥–∞–∑–∏–Ω—ã",
        add_button: "+ –î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω",
        modal_title: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",
        modal_email_label: "–ø–æ email",
        modal_add: "–î–æ–±–∞–≤–∏—Ç—å"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("logout-button").innerText = t.logout;
      document.getElementById("store-title").innerText = t.store_title;
      document.getElementById("add-button").innerText = t.add_button;
      document.getElementById("modal-title").innerText = t.modal_title;
      document.getElementById("email-label").innerText = t.modal_email_label;
      document.getElementById("modal-add-button").innerText = t.modal_add;

      const name = document.getElementById("greeting").getAttribute("data-name");
      document.getElementById("greeting").innerText = t.greeting + name;

      localStorage.setItem("lang", lang);
    }

    function openModal() {
      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    function togglePassword() {
      const input = document.getElementById("store-password");
      input.type = input.type === "password" ? "text" : "password";
    }

    window.onload = function() {
      const phone = localStorage.getItem("user_phone");
      console.log("–°–∞“õ—Ç–∞–ª“ì–∞–Ω –Ω–æ–º–µ—Ä:", phone);
  
      if (!phone) {
        alert("“ö–∞—Ç–µ: “õ–æ–ª–¥–∞–Ω—É—à—ã –Ω”©–º—ñ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã.");
      }
    };
  
    function formatPhone(rawPhone) {
      return '+7 (' + rawPhone.slice(0, 3) + ') ' +
                   rawPhone.slice(3, 6) + ' ' +
                   rawPhone.slice(6, 8) + ' ' +
                   rawPhone.slice(8, 10);
    }
  
    // ‚úÖ –ú–∞–≥–∞–∑–∏–Ω–¥—ñ “õ–æ—Å—É –ª–æ–≥–∏–∫–∞—Å—ã
    document.getElementById("modal-add-button").addEventListener("click", async () => {
      const login = document.getElementById("store-email").value.trim();
      const password = document.getElementById("store-password").value.trim();
      const rawPhone = localStorage.getItem("user_phone");
  
      if (!login || !password || !rawPhone) {
        alert("‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑.");
        return;
      }
  
      const phone = rawPhone;
  
      try {
        const res = await fetch("/add_kaspi_shop", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ login, password, phone })
        });
      
        let data;
        try {
          data = await res.json();
        } catch (e) {
          alert("‚ùå –°–µ—Ä–≤–µ—Ä JSON “õ–∞–π—Ç–∞—Ä–∞ –∞–ª–º–∞–¥—ã (Internal Server Error)");
          return;
        }
      
        if (data.ok) {
          alert("‚úÖ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—ã–ª–¥—ã: " + data.name);
          closeModal();
      
          const card = document.createElement("div");
          card.className = "border p-4 rounded shadow bg-white";
          card.innerHTML = `
            <h3 class="font-bold text-lg mb-1">${data.name}</h3>
            <p class="text-sm text-gray-500">${login}</p>
          `;
          document.getElementById("store-list").appendChild(card);
      
          document.getElementById("store-email").value = "";
          document.getElementById("store-password").value = "";
        } else {
          alert("‚ùå “ö–∞—Ç–µ: " + data.msg);
        }
      
      } catch (e) {
        console.error(e);
        alert("‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.");
}
  });
  </script>
</body>
</html>
