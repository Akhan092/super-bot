<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SuperBOT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- üîù –¢—ñ–ª –º–µ–Ω —à—ã“ì—É -->
	<div class="bg-white shadow p-4 flex justify-between items-center text-sm sm:text-base px-4 sm:px-8">
	  <div class="space-x-2">
		<button onclick="setLanguage('kk')" class="text-blue-600 hover:underline">KAZ</button>
		<span>/</span>
		<button onclick="setLanguage('ru')" class="text-blue-600 hover:underline">RU</button>
	  </div>
	  <a id="logout-button" href="/" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">
		–®—ã“ì—É
	  </a>
	</div>

	<!-- üëã –°”ô–ª–µ–º -->
	<div class="mt-10 px-4 sm:px-0 flex justify-center">
	  <h1 id="greeting" data-name="{{ name }}"
		  class="text-3xl sm:text-4xl font-bold text-gray-800 text-center">
		–°”ô–ª–µ–º, {{ name }}
	  </h1>
	</div>

	<!-- üì¶ –ú–∞–≥–∞–∑–∏–Ω —Ç—ñ–∑—ñ–º—ñ -->
	<div class="mt-8 px-4 sm:px-6 flex justify-center">
	  <div class="bg-white shadow rounded-xl w-full max-w-6xl p-4 sm:p-6">
		
		<!-- üîù –¢–∞“õ—ã—Ä—ã–ø –ø–µ–Ω –∫–Ω–æ–ø–∫–∞ -->
		<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-2 sm:space-y-0">
		  <h2 id="store-title" class="text-lg sm:text-xl font-semibold text-gray-800"></h2>
		  <button onclick="openModal()" id="add-button"
				  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
			+ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É
		  </button>
		</div>

		<!-- üß© –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–∫–∞–ª–∞—Ä—ã –æ—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ—à—ñ–Ω–¥–µ -->
		<div id="store-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
		  {% for shop in shops %}
		  <div class="border rounded-xl shadow p-4 bg-white relative">
			<h3 class="text-lg font-bold mb-1">{{ shop.shop_name }}</h3>
			<p class="text-xs text-gray-500">ID: {{ shop.merchant_id }}</p>
			<p class="text-xs text-blue-600 mt-1">
			  üïí –ê–∫—Ç–∏–≤–µ–Ω –¥–æ: 
			  {{ (shop.created_at + timedelta(hours=72)).strftime('%Y-%m-%d %H:%M:%S') }}<br>
			  ‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: 
			  {{ ((shop.created_at + timedelta(hours=72)) - datetime.utcnow()).days }} –∫“Ø–Ω
			</p>
			<button onclick="deleteStore('{{ shop.shop_name }}', this)"
					class="absolute top-2 right-2 text-sm text-red-500 hover:underline">
			  ”®—à—ñ—Ä—É
			</button>
		  </div>
		  {% endfor %}
		</div>

	  </div>
	</div>



  <!-- ü™ü –ú–æ–¥–∞–ª -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-400 hover:text-black text-xl">&times;</button>
      <h2 id="modal-title" class="text-xl font-bold text-center mb-4">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</h2>

      <div class="flex justify-center items-center space-x-2 mb-4">
        <img src="https://upload.wikimedia.org/wikipedia/ru/a/aa/Logo_of_Kaspi_bank.png" alt="Kaspi"
             class="w-10 h-10 object-contain">
        <span class="text-lg font-semibold text-gray-800">Kaspi</span>
      </div>

      <p id="email-label" class="text-center text-sm text-gray-500 mb-2">–ø–æ email</p>
      <input id="store-email" type="email" placeholder="Email"
             class="border p-2 rounded w-full mb-3" />

      <div class="relative mb-1">
        <input id="store-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
               class="border p-2 rounded w-full pr-10" />
        <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-2 flex items-center text-gray-500">
          üëÅÔ∏è
        </button>
      </div>

      <p id="store-error" class="text-sm text-red-600 mt-1 mb-3"></p>

      <button id="modal-add-button"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
        –î–æ–±–∞–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- ‚úÖ JavaScript -->
  <script>
    const texts = {
      kk: {
        logout: "–®—ã“ì—É",
        greeting: "–°”ô–ª–µ–º, ",
        store_title: "–ú–∞–≥–∞–∑–∏–Ω–¥–µ—Ä—ñ“£—ñ–∑",
        add_button: "+ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_title: "–ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—É",
        modal_email_label: "email –∞—Ä“õ—ã–ª—ã",
        modal_add: "“ö–æ—Å—É"
      },
      ru: {
        logout: "–í—ã–π—Ç–∏",
        greeting: "–ü—Ä–∏–≤–µ—Ç, ",
        store_title: "–í–∞—à–∏ –º–∞–≥–∞–∑–∏–Ω—ã",
        add_button: "+ –î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω",
        modal_title: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",
        modal_email_label: "–ø–æ email",
        modal_add: "–î–æ–±–∞–≤–∏—Ç—å"
      }
    };

    function setLanguage(lang) {
      const t = texts[lang];
      document.getElementById("logout-button").innerText = t.logout;
      document.getElementById("store-title").innerText = t.store_title;
      document.getElementById("add-button").innerText = t.add_button;
      document.getElementById("modal-title").innerText = t.modal_title;
      document.getElementById("email-label").innerText = t.modal_email_label;
      document.getElementById("modal-add-button").innerText = t.modal_add;

      const name = document.getElementById("greeting").getAttribute("data-name");
      document.getElementById("greeting").innerText = t.greeting + name;

      localStorage.setItem("lang", lang);
    }

    function openModal() {
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("store-error").innerText = "";
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("store-error").innerText = "";
    }

    function togglePassword() {
      const input = document.getElementById("store-password");
      input.type = input.type === "password" ? "text" : "password";
    }

    function renderStoreCard(shop) {
      const card = document.createElement("div");
      card.className = "border p-4 rounded shadow bg-white relative";
    
      const createdAt = new Date(shop.created_at).toLocaleString("kk-KZ", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    
      card.innerHTML = `
        <h3 class="text-lg font-bold mb-1">${shop.name || shop.shop_name}</h3>
        <p class="text-sm text-gray-600">–õ–æ–≥–∏–Ω: ${shop.login}</p>
        <p class="text-sm text-red-600">–ü–∞—Ä–æ–ª—å: ${shop.password}</p>
        <p class="text-xs text-blue-500 mt-1">–¢—ñ—Ä–∫–µ–ª–≥–µ–Ω: ${createdAt}</p>
        <button onclick="deleteStore('${shop.name}', this)"
                class="absolute top-2 right-2 text-sm text-red-500 hover:underline">
          ”®—à—ñ—Ä—É
        </button>
      `;
      document.getElementById("store-list").appendChild(card);
    }




    function deleteStore(name, el) {
      const phone = localStorage.getItem("user_phone");
    
      if (!confirm(`‚Äú${name}‚Äù –º–∞–≥–∞–∑–∏–Ω—ñ–Ω ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?`)) return;
    
      fetch("/delete_kaspi_shop", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ name, phone })
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.ok) {
            el.closest(".border").remove();
          } else {
            alert("“ö–∞—Ç–µ: " + (data.msg || "–ú–∞–≥–∞–∑–∏–Ω ”©—à—ñ—Ä—ñ–ª–º–µ–¥—ñ"));
          }
        })
        .catch((err) => {
          console.error(err);
          alert("‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.");
        });
    }


    window.onload = function () {
	  const phone = localStorage.getItem("user_phone");
	  if (!phone) {
	    alert("“ö–∞—Ç–µ: “õ–æ–ª–¥–∞–Ω—É—à—ã –Ω”©–º—ñ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã.");
	    return;
	  }
	
	  // üî§ –¢—ñ–ª–¥—ñ –∞–Ω—ã“õ—Ç–∞—É
	  const savedLang = localStorage.getItem("lang");
	  const browserLang = navigator.language.startsWith("ru") ? "ru" : "kk";
	  const lang = savedLang || browserLang;
	
	  setLanguage(lang); // üü¢ –ú”ô—Ç—ñ–Ω–¥–µ—Ä–¥—ñ –¥“±—Ä—ã—Å —Ç—ñ–ª–¥–µ –∫”©—Ä—Å–µ—Ç—É
	};

 
    function editStore(name) {
      alert(`"${name}" –º–∞–≥–∞–∑–∏–Ω—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É –ª–æ–≥–∏–∫–∞—Å—ã –∫–µ–π—ñ–Ω “õ–æ—Å—ã–ª–∞–¥—ã.`);
    }

    document.getElementById("modal-add-button").addEventListener("click", async () => {
      const login = document.getElementById("store-email").value.trim();
      const password = document.getElementById("store-password").value.trim();
      const errorLabel = document.getElementById("store-error");
      const button = document.getElementById("modal-add-button");
      const rawPhone = localStorage.getItem("user_phone");
    
      if (!login || !password || !rawPhone) {
        errorLabel.innerText = "‚ö†Ô∏è –ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑.";
        return;
      }
    
      const phone = rawPhone;
      button.disabled = true;
      button.innerHTML = `<svg class="animate-spin h-4 w-4 mr-2 inline" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10"
                                    stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor"
                                  d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                          </svg> “ö–æ—Å—ã–ª—É–¥–∞...`;
      errorLabel.innerText = "";
    
      try {
        const res = await fetch("/add_kaspi_shop", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ login, password, phone })
        });
    
        const data = await res.json();
    
        if (
          data.ok &&
          data.name &&
          data.login &&
          data.password &&
          data.created_at
        ) {
          document.getElementById("store-email").value = "";
          document.getElementById("store-password").value = "";
          closeModal();
          alert("‚úÖ –ú–∞–≥–∞–∑–∏–Ω “õ–æ—Å—ã–ª–¥—ã. “ö–∞—Ä–∞—É “Ø—à—ñ–Ω –±–µ—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—ã“£—ã–∑.");
        } else {
          errorLabel.innerText = "‚ùå –õ–æ–≥–∏–Ω –Ω–µ–º–µ—Å–µ –ø–∞—Ä–æ–ª—å “õ–∞—Ç–µ.";
        }
    
      } catch (e) {
        console.error(e);
        errorLabel.innerText = "‚ùå –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª–∞ –∞–ª–º–∞–¥—ã.";
      } finally {
        button.disabled = false;
        button.innerText = "–î–æ–±–∞–≤–∏—Ç—å";
      }
    });

  </script>
</body>
</html>
